name: Playwright Tests
on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"  # Reduced frequency to prevent overlap
jobs:
  test:
    timeout-minutes: 20  # Increased timeout
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache Node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/ms-playwright
          node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - uses: actions/setup-node@v4
      with:
        node-version: 20  # Pinned to specific LTS version
    
    - name: Install dependencies
      run: npm ci --prefer-offline
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    
    - name: Create .env file
      run: |
        cat << EOF > .env
        EMAIL=${{ secrets.EMAIL }}
        PASSWORD=${{ secrets.PASSWORD }}
        MAX_FUEL_PRICE=${{ vars.MAX_FUEL_PRICE }}
        MAX_CO2_PRICE=${{ vars.MAX_CO2_PRICE }}
        EOF
    
    - name: Run Playwright tests with retries
      run: npx playwright test --retries=2  # Automatic retries for flaky tests
    
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 1
